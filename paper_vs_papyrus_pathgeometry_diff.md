# paper.js と Papyrus2D の PathGeometry アルゴリズム比較

このドキュメントでは、paper.jsとPapyrus2DのPathGeometryに関連するアルゴリズム上の本質的な違いを分析します。モジュール構造や単なる型強化の違いは報告せず、挙動に差が出うる可能性のある違いに焦点を当てます。

## 1. isOnPath 関数の実装

Papyrus2Dでは曲線上の点の検出において、曲線が直線でない場合に三次方程式を解いて最近接点を求める方法を使用しています。一方、paper.jsでは`Curve.getNearestLocation`を使用しています。この違いにより、特に複雑な曲線上の点の検出において、わずかな精度の違いが生じる可能性があります。

## 2. getIntersections 関数の境界ボックスチェック

Papyrus2Dでは自己交差でない場合のみ境界ボックスチェックを行いますが、paper.jsでは常に境界ボックスチェックを行います。この違いにより、自己交差を含む複雑なパスの交点計算において、計算効率や結果に違いが生じる可能性があります。

## 3. contains 関数の境界チェック

Papyrus2Dでは点がパス内部にあるかどうかを判定する前に、まず境界ボックスチェックを行い、点が境界外なら早期リターンします。paper.jsではこの最適化がなく、直接winding numberを計算します。この違いにより、パスの外側にある点の判定が高速化される可能性がありますが、境界付近の点の判定に微妙な違いが生じる可能性もあります。

## 4. CurveLocation.isTouching メソッドの実装

Papyrus2Dでは`getLine()`と`intersect()`の実装が不完全なため、接触判定が常にfalseを返す可能性があります。これにより、曲線の接触判定において、paper.jsとは異なる結果が得られる可能性があります。

## 5. CurveSubdivision.divideCurve のエラーハンドリング

Papyrus2Dでは曲線の分割位置が範囲外の場合に例外をスローしますが、paper.jsではnullを返します。この違いにより、境界条件での曲線分割の挙動が異なります。特に、t=0やt=1に近い値での分割において、paper.jsでは分割が行われないのに対し、Papyrus2Dでは例外が発生します。

## 6. ベジェ曲線の評価方法

Papyrus2Dでは点の計算時に明示的に中間変数を使用していますが、paper.jsでは直接多項式を計算しています。この違いにより、数値計算の精度に微妙な違いが生じる可能性があります。特に、複雑な曲線や極端な制御点を持つ曲線の評価において、丸め誤差の蓄積が異なる可能性があります。

## 結論

paper.jsとPapyrus2DのPathGeometry関連のアルゴリズムは基本的に同じですが、上記の違いにより、特定の状況下で挙動に差が生じる可能性があります。特に、境界条件や数値計算の精度に関わる部分で違いが見られます。これらの違いは通常の使用では目立たないかもしれませんが、複雑な形状や極端なケースでは結果に違いが現れる可能性があります。