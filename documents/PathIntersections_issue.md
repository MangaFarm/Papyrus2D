# PathIntersections.test.ts の問題点分析

これから行う修正だけ書きます。過去に行った修正は随時削除します。
このファイルはレポートではありません。行った修正はノイズなので、必ず削除してください。
テストに通らなくても、修正を行ったのなら削除してください。検証は別途行います。

## 問題の概要

`PathIntersections.test.ts` のテストが失敗しています。主な問題は、交点の数が期待値と一致していないことです：

- 円と円の交差テスト：期待値は2点の交点ですが、実際には3点の交点が検出されています（修正後）
- 円と四角形の交差テスト：期待値は2点の交点ですが、実際には交点が検出されていません
- 自己交差テスト：交点が検出されていません
- その他のテストケースでも交点が検出されていないものが多い

## Path.getIntersections と paper.js の getIntersections の違い

3. **CurveLocation構造の違い**:
   - Papyrus2DのCurveLocationはインターフェースとして定義されていますが、paper.jsではクラスとして実装されています。
   - Papyrus2Dでは`curve1Index`と`curve2Index`が追加されていますが、paper.jsでは交点が見つかった後に曲線インデックスが設定される仕組みになっています。

4. **交点の重複チェック**:
   - `insertLocation`関数の実装に違いがあり、Papyrus2Dでは重複チェックの条件が異なります。
   - paper.jsでは`CurveLocation.insert`メソッドを使用していますが、Papyrus2Dでは独自の`insertLocation`関数を実装しています。

5. **自己交差の検出**:
   - 円と円の交差テストで3点の交点が検出される問題は、自己交差検出の実装に関連している可能性があります。
   - 特に、円のセグメントがループ曲線として分類され、自己交差点が追加されている可能性があります。
   - paper.jsでは、Curve.classify関数は曲線の分類を行い、ループ曲線の場合は自己交差点のルートを返します。
   - 円のセグメントが誤ってループ曲線として分類されている可能性があります。
   - paper.jsの実装に忠実に従い、自己交差の検出を正確に再現する必要があります。

