# PathIntersections.test.ts の問題点分析

これから行う修正だけ書きます。過去に行った修正は随時削除します。

## 問題の概要

`PathIntersections.test.ts` のテストが失敗しています。主な問題は、交点の数が期待値と一致していないことです：

- 円と円の交差テスト：期待値は2点の交点ですが、実際には11点の交点が検出されています
- 円と四角形の交差テスト：期待値は2点の交点ですが、実際には交点が検出されていません
- 自己交差テスト：交点が検出されていません

## Paper.jsとの主な相違点

### 1. 境界ボックスの計算方法

- Paper.jsでは、境界ボックスの計算に制御点のみを使用しています
- Papyrus2Dでは、曲線の極値点も考慮して境界ボックスを計算しています

### 2. CurveLocationの実装

- Paper.jsでは、CurveLocationクラスに_intersection、_next、_previousなどのプロパティがあります
- Papyrus2Dでは、これらのプロパティがありません

### 3. 自己交差検出

- Paper.jsでは、ループ曲線の場合のみ自己交差点を追加しています
- Papyrus2Dでは、蛇行曲線の場合も自己交差点を追加しています

### 4. 交点の追加と重複フィルタリング

- Paper.jsでは、2つのCurveLocationオブジェクトを作成し、相互参照を設定しています
- Papyrus2Dでは、1つのCurveLocationオブジェクトしか作成していません

### 5. 境界ボックスの交差判定

- Paper.jsでは、境界ボックスのチェックはCurve.getIntersections内部で行われています
- Papyrus2Dでは、Path.getIntersectionsメソッド内で境界ボックスのチェックを行っています

## 修正方針

Paper.jsとの相違点を優先的に修正し、Paper.jsの実装に忠実に合わせることを最優先します。独自の改善や最適化は行わず、まずはPaper.jsの実装を正確に再現することに注力します。