# PathIntersections.test.ts の問題点分析

これから行う修正だけ書きます。過去に行った修正は随時削除します。
このファイルはレポートではありません。行った修正はノイズなので、必ず削除してください。

## 問題の概要とテスト結果の分析

`PathIntersections.test.ts` のテストが失敗しています。テスト実行の結果、以下の問題が確認されました：

1. **円と円の交差テスト**：期待値は2点の交点ですが、実際には3点の交点が検出されています。
2. **円と四角形の交差テスト**：期待値は2点の交点ですが、実際には交点が検出されていません（0点）。
3. **自己交差テスト**：交点が検出されていません（0点）。
4. **行列変換を適用したパスの交点計算**：交点が検出されていません（0点）。
5. **複雑な曲線の交点計算**：交点が検出されていません（0点）。
6. **フィルタリングテスト**：基本的な交点計算が失敗しているため、フィルタリングも機能していません。

## 実装の違いと修正予定

詳細な調査の結果、Papyrus2DのPath.getIntersectionsとpaper.jsのPathItem.getIntersectionsには以下の相違点があり、これらが問題の原因と考えられます：

1. **境界ボックスの扱い**:
   - Paper.js: 最初に両方のパスの境界ボックスが交差するかチェックし、交差しない場合は早期に空の配列を返す
   - Papyrus2D: この事前チェックを省略し、直接Curve.getIntersectionsを呼び出している
   - **修正予定**: Paper.jsと同様に、Path.getIntersectionsの最初に境界ボックスの交差チェックを追加する

2. **曲線の交点計算アルゴリズム**:
   - 再帰の深さや呼び出し回数の制限、fat-lineクリッピングの処理に微妙な違いがある
   - **修正予定**: addCurveIntersections関数を修正し、特に再帰終了条件と精度の扱い、fat-lineクリッピングの実装を詳細に確認する

3. **オーバーラップ検出**:
   - 直線距離の計算方法やオーバーラップ判定の条件に違いがある
   - **修正予定**: getOverlaps関数を修正し、特に直線距離の計算方法とオーバーラップ判定条件を確認する

4. **自己交差の検出**:
   - getSelfIntersection関数やCurve.classifyの結果の扱いに問題がある
   - **修正予定**: getSelfIntersection関数とCurve.classifyの実装を確認し、自己交差が正しく検出されるようにする

5. **行列変換の処理**:
   - 行列変換を適用したパスの交点計算が失敗している
   - **修正予定**: 行列変換を適用したパスの交点計算が正しく機能するように修正する

6. **許容誤差値**:
   - 許容誤差値自体はpaper.jsと同じだが、使用方法に違いがある可能性がある
   - **修正予定**: 許容誤差値の使用方法を確認し、必要に応じて修正する

## 修正方針

Paper.jsとの相違点を優先的に修正し、Paper.jsの実装に忠実に合わせることを最優先します。独自の改善や最適化は行わず、まずはPaper.jsの実装を正確に再現することに注力します。特に、交点計算の精度と安定性に関わる部分を重点的に確認します。

修正の順序としては、まず基本的な交点計算（直線同士、曲線と直線）が正しく機能するようにし、次に複雑なケース（曲線同士、自己交差）に進むことが効果的でしょう。