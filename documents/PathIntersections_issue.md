# PathIntersections.test.ts の問題点分析

これから行う修正だけ書きます。過去に行った修正は随時削除します。
このファイルはレポートではありません。行った修正はノイズなので、必ず削除してください。
テストに通らなくても、修正を行ったのなら削除してください。検証は別途行います。

## 問題の概要

`PathIntersections.test.ts` のテストが失敗しています。主な問題は、交点の数が期待値と一致していないことです：

- 円と円の交差テスト：期待値は2点の交点ですが、実際には3点の交点が検出されています（修正後）
- 円と四角形の交差テスト：期待値は2点の交点ですが、実際には交点が検出されていません
- 自己交差テスト：交点が検出されていません
- その他のテストケースでも交点が検出されていないものが多い

## Path.getIntersections と paper.js の getIntersections の違い

Papyrus2DのPath.getIntersectionsとpaper.jsのPathItem.getIntersectionsを比較した結果、以下の違いが見つかりました：

1. **交点情報の構造の違い**:
   - paper.jsでは、交点情報は`CurveLocation`クラスのインスタンスとして作成され、相互参照が設定されます。
   - Papyrus2Dでは、交点情報はインターフェースとして定義され、オブジェクトリテラルとして作成されています。

2. **曲線インデックスの設定タイミング**:
   - paper.jsでは、交点が見つかった時点で`CurveLocation`オブジェクトが作成され、後から曲線インデックスが設定されます。
   - Papyrus2Dでは、`getCurveIntersections`関数内で交点が見つかった後、曲線インデックスを設定していますが、一部のケースで設定されていない可能性があります。

3. **行列変換の処理**:
   - paper.jsでは、交点計算後に元の座標系に戻す処理が行われていますが、Papyrus2Dでは一部のケースでこの処理が不完全です。
   - 特に、`addCurveIntersections`関数内で行列変換を適用した後の逆変換処理が不足しています。

4. **自己交差の処理**:
   - paper.jsでは自己交差の検出が完全に実装されていますが、Papyrus2Dでは一部のケースで検出できていない可能性があります。
   - 特に、`getSelfIntersection`関数の呼び出し後の処理に違いがあります。

5. **境界ボックスの計算と交差判定**:
   - paper.jsでは境界ボックスの交差判定が厳密に行われていますが、Papyrus2Dでは一部のケースで判定が不正確な可能性があります。
   - `CollisionDetection.findCurveBoundsCollisions`の結果の処理方法に違いがあります。

6. **端点の処理**:
   - paper.jsでは端点の特別な処理が行われていますが、Papyrus2Dでは一部のケースでこの処理が不完全です。
   - 特に、隣接する曲線の端点の処理に違いがあります。

7. **数値計算の精度と安定性**:
   - paper.jsでは数値計算の安定性を確保するための処理が多く含まれていますが、Papyrus2Dでは一部の処理が簡略化されています。
   - 特に、`fatLineEpsilon`などの定数の使用方法に違いがあります。

## 修正方針

Paper.jsとの相違点を優先的に修正し、Paper.jsの実装に忠実に合わせることを最優先します。独自の改善や最適化は行わず、まずはPaper.jsの実装を正確に再現することに注力します。