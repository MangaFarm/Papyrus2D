# PathIntersections.test.ts の問題点分析

これから行う修正だけ書きます。過去に行った修正は随時削除します。
このファイルはレポートではありません。行った修正はノイズなので、必ず削除してください。

## 問題の概要

`PathIntersections.test.ts` のテストが失敗しています。主な問題は、交点の数が期待値と一致していないことです：

- 円と円の交差テスト：期待値は2点の交点ですが、実際には11点の交点が検出されています
- 円と四角形の交差テスト：期待値は2点の交点ですが、実際には交点が検出されていません
- 自己交差テスト：交点が検出されていません

## Path.getIntersections と paper.js の getIntersections の違い

paper.jsとPapyrus2Dの実装を比較した結果、以下の違いが見つかりました：

1. **自己交差チェック（getSelfIntersection）**:
   - paper.jsでは、ループ曲線の場合に自己交差点を追加します
   - Papyrus2Dでも同様の実装をしていますが、`Curve.classify`の結果処理に問題がある可能性があります
   - 特に、ループ曲線の判定条件とルートの取得方法に違いがあります

2. **曲線同士の交点計算（addCurveIntersections）**:
   - paper.jsでは、Fat-lineアルゴリズムを使用して曲線を再帰的に分割し交点を計算します
   - Papyrus2Dでも同様のアルゴリズムを実装していますが、以下の点で違いがあります：
     - 凸包のクリッピング処理（`clipConvexHull`）の実装が正確でない可能性があります
     - 再帰の終了条件や分割方法の実装に問題がある可能性があります
     - 数値計算の精度に関する問題がある可能性があります

3. **オーバーラップの検出（getOverlaps）**:
   - paper.jsでは、曲線が重なる場合に特別な処理を行います
   - Papyrus2Dでも同様の実装をしていますが、以下の点で違いがあります：
     - 重なりの判定条件が厳しすぎる可能性があります
     - 曲線の端点や制御点の距離計算に問題がある可能性があります

4. **交点の重複判定（insertLocation）**:
   - paper.jsでは、交点の重複を判定するために点の距離とtパラメータを使用します
   - Papyrus2Dでも同様の実装をしていますが、以下の点で違いがあります：
     - 重複判定の順序が異なります（paper.jsでは点の距離を先にチェックしますが、Papyrus2Dではtパラメータを先にチェックしていました）
     - 重複判定の条件が厳しすぎる可能性があります

5. **曲線と直線の交点計算（addCurveLineIntersections）**:
   - paper.jsでは、曲線と直線の交点を計算する際に、交点が線分上にあるかどうかを厳密にチェックします
   - Papyrus2Dでも同様の実装をしていますが、以下の点で違いがあります：
     - 交点が線分上にあるかどうかのチェックが不十分である可能性があります
     - 数値計算の精度に関する問題がある可能性があります

## 残りの修正予定

1. **addCurveIntersections関数の修正**: 曲線同士の交点計算アルゴリズムをPaper.jsと完全に一致させる
   - 凸包のクリッピング処理を正確に実装する
   - 再帰の終了条件や分割方法を修正する
   - 数値計算の精度を調整する

2. **getOverlaps関数の修正**: オーバーラップ検出アルゴリズムをPaper.jsと完全に一致させる
   - 重なりの判定条件を調整する
   - 曲線の端点や制御点の距離計算を修正する

3. **Numerical.tsの許容誤差値の確認**: Paper.jsと同じ許容誤差値を使用しているか確認する
   - GEOMETRIC_EPSILON
   - CURVETIME_EPSILON
   - EPSILON

## 修正方針

Paper.jsとの相違点を優先的に修正し、Paper.jsの実装に忠実に合わせることを最優先します。独自の改善や最適化は行わず、まずはPaper.jsの実装を正確に再現することに注力します。