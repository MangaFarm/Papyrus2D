# PathIntersections.test.tsのテスト失敗の原因

テスト結果と実装の比較から、paper.jsとPapyrus2Dの間に以下の重要な違いが見つかりました：

## 1. 交点計算アルゴリズムの違い

### 直線交差の計算方法
- **paper.js**: `Line.intersect`関数を使用
- **Papyrus2D**: 独自の`lineIntersect`関数を実装しており、クラメルの公式を使用

### 曲線交差の処理
- **paper.js**: 曲線同士の交差計算で、fat-lineクリッピングアルゴリズムを使用
- **Papyrus2D**: 同様のアルゴリズムを実装しているが、数値計算の安定性に関する処理が異なる

## 2. 行列変換の処理

- **paper.js**: `_orNullIfIdentity()`メソッドが`null`を返す場合の処理が適切に行われている
- **Papyrus2D**: `this._matrix`が`undefined`の場合に`_orNullIfIdentity()`を呼び出すとエラーが発生する可能性がある

## 3. 境界チェックの問題

- **paper.js**: 境界ボックスの交差判定が正確に行われている
- **Papyrus2D**: 境界ボックスの交差判定は正しく行われているが、その後の処理に問題がある可能性がある

## 4. オーバーラップの処理

- **paper.js**: `getOverlaps`関数が2つのペアを返す場合、それらは適切に処理される
- **Papyrus2D**: `getOverlaps`関数の実装は似ているが、オーバーラップの検出と処理に微妙な違いがある

## 5. 数値計算の精度

- **paper.js**: 数値計算の安定性のための特別な処理が多数実装されている
- **Papyrus2D**: 同様の処理を実装しているが、一部の数値計算の精度に関する処理が異なる

## 結論

テスト失敗の根本的な原因は、paper.jsとPapyrus2Dの間の交点計算アルゴリズムの実装の違いです。特に、曲線同士の交差計算と直線交差の計算方法に違いがあります。また、オーバーラップの処理や数値計算の精度に関する処理の違いも、テスト失敗の原因となっています。

これらの違いにより、一部のテストケースでは交点が検出されず、他のテストケースでは期待より多くの交点が検出されるという問題が発生しています。